// =======================================================
// ★★★ 新機能：業務改善インパクト診断ロジック ★★★
// =======================================================
const impactForm = document.getElementById('impact-form');
const resultContainer = document.getElementById('simulator-result');

if (impactForm) {
    impactForm.addEventListener('submit', (e) => {
        e.preventDefault();

        const dailyMinutes = parseFloat(document.getElementById('daily-minutes').value);
        const teamSize = parseFloat(document.getElementById('team-size').value);

        if (isNaN(dailyMinutes) || isNaN(teamSize) || dailyMinutes <= 0 || teamSize <= 0) {
            showNotification('1以上の有効な数値を入力してください。', 'error');
            return;
        }

        const IMPROVEMENT_RATE = 0.8;
        const WORKING_DAYS_PER_MONTH = 20;
        const savedMonthlyHours = ((dailyMinutes * teamSize * WORKING_DAYS_PER_MONTH) * IMPROVEMENT_RATE) / 60;
        
        displayResult(savedMonthlyHours);
    });
}

function displayResult(hours) {
    resultContainer.classList.remove('visible');
    
    setTimeout(() => {
        const roundedHours = Math.round(hours);
        resultContainer.innerHTML = `
            <p class="result-lead-text">あなたのチームでは...</p>
            <div class="result-time" data-target="${roundedHours}">0 <span>時間/月</span></div>
            <p class="result-sub-text">の「創造的な時間」が生まれる可能性があります。</p>
            <p class="result-note">※一般的なAI導入による業務削減率を80%と仮定した参考値です。<br>この時間を、新しい企画や顧客満足度の向上に活用しませんか？</p>
            <a href="#contact"><button class="cta-button-blue">具体的な方法を相談する</button></a>
        `;
        resultContainer.classList.add('visible');

        const timeElement = resultContainer.querySelector('.result-time');
        animateSingleCounter(timeElement);
        
        resultContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 300);
}

function animateSingleCounter(element) {
    const target = parseInt(element.dataset.target, 10);
    if (isNaN(target)) return;

    let current = 0;
    const duration = 1500;
    const stepTime = 16;
    const totalSteps = duration / stepTime;
    let increment = target / totalSteps;
    if (target > 0 && increment < 1) increment = 1;

    const updateCounter = () => {
        current += increment;
        if (current < target) {
            element.innerHTML = `${Math.ceil(current)} <span>時間/月</span>`;
            requestAnimationFrame(updateCounter);
        } else {
            element.innerHTML = `${target} <span>時間/月</span>`;
        }
    };
    updateCounter();
}

// 診断ツール用の通知機能
function showNotification(message, type = 'info') {
    const existingNotification = document.querySelector('.site-notification');
    if (existingNotification) existingNotification.remove();
    
    const notification = document.createElement('div');
    notification.className = 'site-notification';
    notification.textContent = message;
    
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 24px;
        border-radius: 6px;
        color: #fff;
        background-color: ${type === 'error' ? '#d9534f' : '#0275d8'};
        box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        z-index: 9999;
        font-weight: bold;
        opacity: 0;
        transition: opacity 0.3s ease;
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => { notification.style.opacity = '1'; }, 10);
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.addEventListener('transitionend', () => notification.remove());
    }, 4000);
}
